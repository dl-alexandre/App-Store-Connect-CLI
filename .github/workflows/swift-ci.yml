name: Swift CI

on:
  push:
    branches: [main]
    paths:
      - 'swift-asc-cli/**'
      - '.github/workflows/swift-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'swift-asc-cli/**'
      - '.github/workflows/swift-ci.yml'
  release:
    types: [published]

env:
  SWIFT_VERSION: '5.9'
  WORKING_DIRECTORY: swift-asc-cli

jobs:
  # Debug build and test job
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Verify Swift version
        run: swift --version

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/.build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-swift-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build (Debug)
        run: swift build --configuration debug

      - name: Run tests
        run: swift test --configuration debug
        env:
          ASC_BYPASS_KEYCHAIN: '1'

      - name: Check SwiftLint
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --reporter github-actions-logging
          else
            echo "SwiftLint not installed, skipping linting"
          fi
        continue-on-error: true

      - name: Upload debug build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swift-debug-build
          path: |
            ${{ env.WORKING_DIRECTORY }}/.build/debug/asc-swift
          retention-days: 7

  # Release build job
  build-release:
    name: Build Release
    runs-on: macos-latest
    needs: build-and-test
    if: github.event_name == 'push' || github.event_name == 'release'
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/.build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-swift-release-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-release-
            ${{ runner.os }}-swift-

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build (Release)
        run: swift build --configuration release

      - name: Strip symbols (optional)
        run: |
          strip .build/release/asc-swift || true

      - name: Upload release build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swift-release-build
          path: |
            ${{ env.WORKING_DIRECTORY }}/.build/release/asc-swift
          retention-days: 14

  # Sign and notarize release binary
  sign-and-notarize:
    name: Sign and Notarize
    runs-on: macos-latest
    needs: build-release
    if: github.event_name == 'release'
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release build
        uses: actions/download-artifact@v4
        with:
          name: swift-release-build
          path: ${{ env.WORKING_DIRECTORY }}/release

      - name: Import Apple Developer Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_ID_CERT }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_ID_PASSWORD }}
        if: env.HAS_CERT == 'true'
        env:
          HAS_CERT: ${{ secrets.APPLE_DEVELOPER_ID_CERT != '' }}

      - name: Sign binary
        if: env.HAS_CERT == 'true'
        run: |
          codesign --force --sign "${{ secrets.APPLE_DEVELOPER_ID }}" \
            --timestamp --options=runtime \
            release/asc-swift
          codesign -dv --verbose=4 release/asc-swift
        env:
          HAS_CERT: ${{ secrets.APPLE_DEVELOPER_ID_CERT != '' }}

      - name: Create release archive
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p dist
          cp release/asc-swift dist/asc-swift
          chmod +x dist/asc-swift
          cd dist
          tar -czf "asc-swift-${VERSION}-macOS.tar.gz" asc-swift
          shasum -a 256 "asc-swift-${VERSION}-macOS.tar.gz" > "asc-swift-${VERSION}-macOS.tar.gz.sha256"

      - name: Upload signed archive
        uses: actions/upload-artifact@v4
        with:
          name: swift-signed-release
          path: ${{ env.WORKING_DIRECTORY }}/dist/*
          retention-days: 30

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.WORKING_DIRECTORY }}/dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Code coverage job
  coverage:
    name: Code Coverage
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/.build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-swift-coverage-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-coverage-
            ${{ runner.os }}-swift-

      - name: Build with coverage
        run: swift build --enable-code-coverage

      - name: Run tests with coverage
        run: swift test --enable-code-coverage
        env:
          ASC_BYPASS_KEYCHAIN: '1'

      - name: Process coverage report
        run: |
          # Find the codecov file
          COV_FILE=$(find .build -name "*.json" -path "*/codecov/*" | head -1)
          if [ -n "$COV_FILE" ]; then
            echo "Found coverage file: $COV_FILE"
            # Convert or upload as needed
          fi
        continue-on-error: true

  # Documentation build
  documentation:
    name: Documentation
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/.build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-swift-docs-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-docs-
            ${{ runner.os }}-swift-

      - name: Build documentation
        run: |
          swift package resolve
          # Generate documentation using DocC
          swift build --target ASCAuth
          swift build --target ASCConfig
          swift build --target ASCCore
          swift build --target ASCCommands
        continue-on-error: true

  # Integration checks
  integration:
    name: Integration Checks
    runs-on: macos-latest
    needs: build-and-test
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/.build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-swift-integration-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-integration-
            ${{ runner.os }}-swift-

      - name: Build release binary
        run: swift build --configuration release

      - name: Test binary execution
        run: |
          ./.build/release/asc-swift --help

      - name: Test with env bypass
        run: |
          ASC_BYPASS_KEYCHAIN=1 ./.build/release/asc-swift auth status 2>&1 || true
        continue-on-error: true
